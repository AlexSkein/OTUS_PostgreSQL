# Отчет по домашке №6

1. Создать инстанс ВМ с 2 ядрами и 4 Гб ОЗУ и SSD 10GB    
1. Установить на него PostgreSQL 15 с дефолтными настройками
    * Устанока
            ```apt-get install postgresql17-server  postgresql17-contrib```
    * Создание кластера 
            ```/etc/init.d/postgresql initdb```

1. Создать БД для тестов: выполнить pgbench -i postgres


1. Запустить pgbench -c8 -P 6 -T 60 -U postgres postgres

    * Тестирование через pgbench при стандартных настройках

    ![pg](/img/6/1.jpg)

1. Применить параметры настройки PostgreSQL из прикрепленного к материалам занятия файла

![pg](/img/6/3.jpg)

1. Протестировать заново

![pg](/img/6/2.jpg)

1. Что изменилось и почему?

* Увеличилось транзакций в секунду (tps)
* Увеличилось количество обработанных транзакций (number of transactions actually processed)
* Уменьшилась средняя латентность (latency average)
* Уменьшились заддержки(латентность) ввода/вывода (latency stddev)
* Увеличилось время подключения (initial connection time)

1. Создать таблицу с текстовым полем и заполнить случайными или сгенерированными данным в размере 1млн строк

**sudo -u postgres psql**

```SQL
   create table tb1(c1 text);
   INSERT INTO tab1(c1) SELECT 'noname' FROM generate_series(1,1000000);
```

1. Посмотреть размер файла с таблицей

```SQL
select pg_size_pretty(pg_table_size('tb1'));

```

![pg](/img/6/5.jpg)

1. 5 раз обновить все строчки и добавить к каждой строчке любой символ

```SQL
postgres=# update tb1 set c1=c1||'q';
UPDATE 1000000
postgres=# update tb1 set c1=c1||'w';
UPDATE 1000000
postgres=# update tb1 set c1=c1||'e';
UPDATE 1000000
postgres=# update tb1 set c1=c1||'r';
UPDATE 1000000
postgres=# update tb1 set c1=c1||'t';
UPDATE 1000000
```

1. Посмотреть количество мертвых строчек в таблице и когда последний раз приходил автовакуум

```SQL
 SELECT relname, n_live_tup, n_dead_tup, trunc(100*n_dead_tup/(n_live_tup+1))::float "ratio%", last_autovacuum FROM pg_stat_user_TABLEs WHERE relname = 'tb1';
```

1. Подождать некоторое время, проверяя, пришел ли автовакуум

![pg](/img/6/6.jpg)

1. 5 раз обновить все строчки и добавить к каждой строчке любой символ

```SQL
postgres=# update tb1 set c1=c1||'q';
UPDATE 1000000
postgres=# update tb1 set c1=c1||'w';
UPDATE 1000000
postgres=# update tb1 set c1=c1||'e';
UPDATE 1000000
postgres=# update tb1 set c1=c1||'r';
UPDATE 1000000
postgres=# update tb1 set c1=c1||'t';
UPDATE 1000000

```

1. Посмотреть размер файла с таблицей

```SQL
select pg_size_pretty(pg_table_size('tb1'));

```

![pg](/img/6/7.jpg)

1. Отключить Автовакуум на конкретной таблице

```SQL
alter table tab1 set (autovacuum_enabled = off);
```

1. 10 раз обновить все строчки и добавить к каждой строчке любой символ


1. Посмотреть размер файла с таблицей

![pg](/img/6/8.jpg)

1. Объясните полученный результат

Автовакуум выключен и при каждом апдейте в таблицу добавляется 1000000 строк.

Не забудьте включить автовакуум)

```SQL
alter table tb1 set (autovacuum_enabled = on);
```
![pg](/img/6/9.jpg)
1. Задание * Написать анонимную процедуру, в которой в цикле 10 раз обновятся все строчки в искомой таблице. Не забыть вывести номер шага цикла.

```SQL
DO
$do$
BEGIN
FOR i IN 1..10 LOOP
RAISE NOTICE 'Step = %', i;
update tb1 set c1=c1||i;
END LOOP;
END
$do$;
```

![pg](/img/6/10.jpg)

**the end**