# Отчет по домашке №12

**Начальное заполнение витрины**

```SQL
    INSERT INTO good_sum_mart
    SELECT DISTINCT g.good_name, sum (s.sales_qty * g.good_price) OVER (PARTITION BY s.good_id)
    FROM goods g INNER JOIN sales s ON s.good_id = g.goods_id;
  

    SELECT * FROM good_sum_mart;

```
![pg](/img/12/1.png)
 

**Триггерная функция**

```SQL
    CREATE OR REPLACE FUNCTION pract_functions.sales_trigger() RETURNS trigger AS 
    $$
        BEGIN
            IF TG_OP = 'INSERT' THEN
                -- Если товар уже есть в витрине
                IF EXISTS 
                    (SELECT *
                    FROM pract_functions.goods g INNER JOIN pract_functions.good_sum_mart gsm
                    ON gsm.good_name = g.good_name
                    WHERE NEW.good_id = g.goods_id
                    )
                THEN
                    WITH good_values (good_name, good_price) AS
                        (SELECT g.good_name, g.good_price FROM pract_functions.goods g
                        WHERE g.goods_id = NEW.good_id)
                    UPDATE pract_functions.good_sum_mart gsm
                        SET sum_sale = sum_sale + good_values.good_price * NEW.sales_qty
                        FROM good_values
                        WHERE gsm.good_name = good_values.good_name;
                    RETURN NEW;
                -- Если это новый товар, которого в витрине пока нет
                ELSE
                    WITH good_values (good_name, good_price) AS
                        (SELECT g.good_name, g.good_price FROM pract_functions.goods g
                        WHERE g.goods_id = NEW.good_id)
                    INSERT INTO pract_functions.good_sum_mart (good_name, sum_sale)
                    SELECT good_name, good_price * NEW.sales_qty
                    FROM good_values;
                    RETURN NEW;
                END IF;
            -- Если запись о продаже обновилась
            ELSIF TG_OP = 'UPDATE' THEN
                WITH good_values (good_name, good_price) AS
                    (SELECT g.good_name, g.good_price FROM pract_functions.goods g
                    WHERE g.goods_id = NEW.good_id)
                UPDATE pract_functions.good_sum_mart gsm
                    SET sum_sale = sum_sale + good_values.good_price * (NEW.sales_qty - OLD.sales_qty)
                    FROM good_values
                    WHERE gsm.good_name = good_values.good_name;			
                RETURN NEW;
            -- Если запись о продаже удалилась
            ELSIF TG_OP = 'DELETE' THEN
                WITH good_values (good_name, good_price) AS
                    (SELECT g.good_name, g.good_price FROM pract_functions.goods g
                    WHERE g.goods_id = OLD.good_id)
                UPDATE pract_functions.good_sum_mart gsm
                    SET sum_sale = sum_sale - good_values.good_price * OLD.sales_qty
                    FROM good_values
                    WHERE gsm.good_name = good_values.good_name;			
                RETURN OLD;
            END IF;	
        END;
    $$
    LANGUAGE 'plpgsql';
```

**Триггеры**

```SQL    
    CREATE OR REPLACE TRIGGER sales_insert
    BEFORE INSERT ON pract_functions.sales
    FOR EACH ROW
    EXECUTE FUNCTION pract_functions.sales_trigger();

    CREATE OR REPLACE TRIGGER sales_update
    BEFORE UPDATE ON pract_functions.sales
    FOR EACH ROW
    EXECUTE FUNCTION pract_functions.sales_trigger();

    CREATE OR REPLACE TRIGGER sales_delete
    AFTER DELETE ON pract_functions.sales
    FOR EACH ROW
    EXECUTE FUNCTION pract_functions.sales_trigger();
```

**Тесты и результаты**

> Исходное положение

```SQL
    SELECT * FROM pract_functions.goods;
```
![pg](/img/12/2.png)

**Добавляем новый товар в goods, продаем его в sales**

```SQL
    INSERT INTO pract_functions.goods (goods_id, good_name, good_price)
    VALUES (5, 'Масло', 5);
    
    INSERT INTO pract_functions.sales (good_id, sales_qty) VALUES (5, 2);
    
    SELECT * FROM pract_functions.good_sum_mart;
```    
![pg](/img/12/3.png)


```SQL
    DELETE FROM pract_functions.goods WHERE goods_id = 3;
    
    SELECT * FROM pract_functions.goods;
```

![pg](/img/12/4.png)

```SQL
    SELECT * FROM pract_functions.sales;
```

![pg](/img/12/5.png)

```SQL
SELECT * FROM pract_functions.good_sum_mart;
```
![pg](/img/12/6.png)

**Добавляем в sales продажу существующего товара**

```SQL
    INSERT INTO pract_functions.sales (good_id, sales_qty) VALUES (1, 2);
    SELECT * FROM pract_functions.good_sum_mart;
```
    
![pg](/img/12/7.png)


**Изменяем данные количества в последней продаже**

```SQL
    SELECT * FROM pract_functions.sales order by sales_id;
```
![pg](/img/12/8.png)

```SQL 
    UPDATE pract_functions.sales SET sales_qty = 4 WHERE sales_id = 6;
    SELECT * FROM pract_functions.good_sum_mart;
```
    
![pg](/img/12/9.png)

**Удаляем продажу с sales_id = 21**

```SQL
    DELETE FROM pract_functions.sales WHERE sales_id = 5;
    
    SELECT * FROM pract_functions.good_sum_mart;
```
![pg](/img/12/10.png)



