# Отчет по домашке №7

1. Настройте выполнение контрольной точки раз в 30 секунд.
    ```SQL
    select name, setting, unit, context from pg_settings where name='checkpoint_timeout';
    ```
    ![pg](/img/7/1.jpg)

    ```SQL
    alter system set checkpoint_timeout = 30;
    ```
    ![pg](/img/7/2.jpg)

    ```SQL
    pg_reload_conf();
    ```
    ![pg](/img/7/3.jpg)
    **посмотрим текущий wal-файл**

    ```SQL
    SELECT pg_current_wal_lsn(), pg_current_wal_insert_lsn(), pg_walfile_name(pg_current_wal_lsn()) file_current_wal_lsn, pg_walfile_name(pg_current_wal_insert_lsn()) file_current_wal_insert_lsn;
    ```
    ![pg](/img/7/4.jpg)

1. 10 минут c помощью утилиты pgbench подавайте нагрузку.

    ```
    sudo -u postgres pgbench -P 30 -T 600 -c 10 postgres
    ```

1. Измерьте, какой объем журнальных файлов был сгенерирован за это время. Оцените, какой объем приходится в среднем на одну контрольную точку.

    **снова посмотрим текущий wal-файл**

    ```SQL
    SELECT pg_current_wal_lsn(), pg_current_wal_insert_lsn(), pg_walfile_name(pg_current_wal_lsn()) file_current_wal_lsn, pg_walfile_name(pg_current_wal_insert_lsn()) file_current_wal_insert_lsn;
    ```
    **Вычмслим размер** 

    ```SQL
    SELECT  pg_size_pretty(pg_wal_lsn_diff('2/CE902DD0'::pg_lsn , '1/F3650878'::pg_lsn)) wal_size;
    ```
    ![pg](/img/7/5.jpg)

    **Зная, что чекпоинты раз в 30секю, вычислим размер wal-файлов между чекпоинтами**

    ```SQL
    SELECT  pg_size_pretty((SELECT  pg_wal_lsn_diff('2/CE902DD0'::pg_lsn , '1/F3650878'::pg_lsn) wal_size)/600*30);
    ```
    ![pg](/img/7/6.jpg)

1. Проверьте данные статистики: все ли контрольные точки выполнялись точно по расписанию. Почему так произошло?

    ```SQL
    select * from pg_stat_checkpointer \gx
    ```
    ![pg](/img/7/7.jpg)

    **restartpoints_timed = 0, следовательно все запланированные контрольные точки выполнены**

1. Сравните tps в синхронном/асинхронном режиме утилитой pgbench. Объясните полученный результат.

    Текущее состояние:
    ```SQL
    SHOW synchronous_commit;
    ```
    ![pg](/img/7/9.jpg)

    **Отключаем**

    ```SQL
    ALTER SYSTEM SET synchronous_commit = off;
    postgres=# SELECT pg_reload_conf();
    ```
    ![pg](/img/7/10.jpg)

    ```
    sudo -u postgres pgbench -P 30 -T 600 -c 10 postgres
    ```
    ![pg](/img/7/11.jpg)

    **tps вырос latency average уменьшилась. Сервер заработал быстрее, нонадежность слегка уменьшилась**

1. Создайте новый кластер с включенной контрольной суммой страниц. Создайте таблицу. Вставьте несколько значений. Выключите кластер. Измените пару байт в таблице. Включите кластер и сделайте выборку из таблицы. Что и почему произошло? как проигнорировать ошибку и продолжить работу?
    **Создаем кластер с параметром -k**

    ```
    sudo -u postgres initdb -k -D /mnt/dz7/data/
    ```
    ![pg](/img/7/12.jpg)

    **Необходимо отредактировать конфигурационный файл. Порт укажем 5452, поскольку стандартный 5432 занят кластером по умолчанию.**
    **Запускаем кластер**

    ```SQL
    sudo -u postgres pg_ctl -D /mnt/dz7/data start
    ```
    ![pg](/img/7/13.jpg)

    **Запустим psql**

    ![pg](/img/7/14.jpg)

    **Создание таблицы**

    ```SQL
    CREATE TABLE tb1(t text);
    ```

    **Добавление данных**

    ```SQL
    INSERT INTO tb1 SELECT 'any string '||s.id FROM generate_series(1,500) AS s(id);
    ```

    **Получим путь к файлу таблицы**

    ```SQL
    SELECT pg_relation_filepath('tb1');
    ```

    ![pg](/img/7/15.jpg)

    **Остановим кластер**

    ```
    sudo -u postgres pg_ctl -D /mnt/dz7/data stop
    ```

    ![pg](/img/7/16.jpg)

    **Испортим табличку, как было в лекции**

    ```
    sudo dd if=/dev/zero of=/mnt/dz7/data/base/5/16387 oflag=dsync conv=notrunc bs=1 count=8
    ```

    ![pg](/img/7/17.jpg)

    **Запустим кластер снова, зайдем в psql и попробуем вывести первые 10 строк**

    ```SQL
    SELECT * from tb1 limit 10;
    ```

    ![pg](/img/7/18.jpg)

    **Отключим проверку суммы и снова попробуем**

    ```
    set ignore_checksum_failure = on;  
    ```

    ![pg](/img/7/19.jpg)

    ```SQL

    SELECT * from tb1 limit 10;
    ```

    **Выборка сформировалась. Можно перенести данные в новую таблицу и удалить битую.**

    ![pg](/img/7/20.jpg)


    
    **the end**