# Отчет по домашке №14
**Разворачиваем 3 виртуальные машины Ubuntu 24.04.3: pg-01, pg-02, pg-03**

**Установка PostgreSQL**

*Устанавливаем PostgreSQL на всех трех ВМ*
```shell
    sudo apt install -y postgresql-common
    sudo /usr/share/postgresql-common/pgdg/apt.postgresql.org.sh
    sudo apt update
```

*Получаем 3 одинаковых сервера PostgreSQL*

    klubkovav@pg-01:~$ sudo pg_lsclusters
    Ver Cluster Port Status Owner    Data directory              Log file
    17  main    5432 online postgres /var/lib/postgresql/17/main /var/log/postgresql/postgresql-17-main.log

    klubkovav@pg-02:~$ sudo pg_lsclusters
    Ver Cluster Port Status Owner    Data directory              Log file
    17  main    5432 online postgres /var/lib/postgresql/17/main /var/log/postgresql/postgresql-17-main.log

    klubkovav@pg-03:~$ sudo pg_lsclusters
    Ver Cluster Port Status Owner    Data directory              Log file
    17  main    5432 online postgres /var/lib/postgresql/17/main /var/log/postgresql/postgresql-17-main.log

*Настройка pg_hba.conf*

Настраивам доступ для репликаций с нужных IP адресов на первых двух серверах.

>    host    replication     all             192.168.2.0/24            scram-sha-256

Задаем на всех трех серверах пароль для пользователя postgres и разрешаем ему сетевой доступ через pg_hba.conf:
```shell
    klubkovav@pg-01:~$ sudo -u postgres psql
    psql (17.6 (Ubuntu 17.6-1.pgdg24.04+1))
    Type "help" for help.

    postgres=# \password postgres
    Enter new password for user "postgres":
    Enter it again:
```

*Настройка pg_hba.conf*

>    host    all             postgres        192.168.155.0/24        scram-sha-256

Перезагружаем конфигурацию и проверяем коннект из pgAdmin:

```SQL
    SELECT pg_reload_conf();
```
    pg_reload_conf
    ----------------
    t
    (1 row)

**Подготовка серверов к репликации**

*cоздаем на каждом сервере БД, схему, 2 таблицы*

```SQL
    CREATE DATABASE demo;
    CREATE SCHEMA replication;
    CREATE TABLE replication.test1 (id integer);
    CREATE TABLE replication.test2 (str text);
```

**Учетные записи для репликации**

*На первых двух серверах создадим учетки*

```SQL
    CREATE ROLE repluser WITH
        LOGIN
        NOSUPERUSER
        NOCREATEDB
        NOCREATEROLE
        INHERIT
        REPLICATION
        NOBYPASSRLS
        CONNECTION LIMIT -1
        PASSWORD '1234';
```

Выдаем ей права - на первой ВМ на таблицу test1, а на второй - на test2.



```SQL
--pg-01
    GRANT USAGE ON SCHEMA replication TO repluser;
    GRANT SELECT ON TABLE replication.test1 TO repluser;
```



```SQL
--pg-02
    GRANT USAGE ON SCHEMA replication TO repluser;
    GRANT SELECT ON TABLE replication.test2 TO repluser;
```

*Публикации и подписки*

```SQL
--pg-01
    CREATE PUBLICATION pub1
        FOR TABLE replication.test1
        WITH (publish = 'insert, update, delete, truncate', publish_via_partition_root = false);
```


```SQL
--pg-02
    CREATE PUBLICATION pub2
    FOR TABLE replication.test2
    WITH (publish = 'insert, update, delete, truncate', publish_via_partition_root = false);
```

**На первой и второй ВМ создаем по одной подписке, а на третьей - две**


```SQL
--pg-01
    CREATE SUBSCRIPTION sub1
        CONNECTION 'host=192.168.2.83 port=5432 user=repluser dbname=demo connect_timeout=10 sslmode=prefer'
        PUBLICATION pub2
        WITH (connect = true, enabled = true, copy_data = true, create_slot = true, synchronous_commit = 'off', binary = false, streaming = 'False', two_phase = false, disable_on_error = false, run_as_owner = false, password_required = true, origin = 'any');
```

```SQL
--pg-02
    CREATE SUBSCRIPTION sub02
        CONNECTION 'host=192.168.2.69 port=5432 user=repluser dbname=demo connect_timeout=10 sslmode=prefer'
        PUBLICATION pub1
        WITH (connect = true, enabled = true, copy_data = true, create_slot = true, synchronous_commit = 'off', binary = false, streaming = 'False', two_phase = false, disable_on_error = false, run_as_owner = false, password_required = true, origin = 'any');
```

```SQL
--pg-03
    CREATE SUBSCRIPTION sub03
        CONNECTION 'host=192.168.2.69 port=5432 user=repluser dbname=demo connect_timeout=10 sslmode=prefer'
        PUBLICATION pub1
        WITH (connect = true, enabled = true, copy_data = true, create_slot = true, synchronous_commit = 'off', binary = false, streaming = 'False', two_phase = false, disable_on_error = false, run_as_owner = false, password_required = true, origin = 'any');

    CREATE SUBSCRIPTION sub04
        CONNECTION 'host=192.168.2.83 port=5432 user=repluser dbname=demo connect_timeout=10 sslmode=prefer'
        PUBLICATION pub2
        WITH (connect = true, enabled = true, copy_data = true, create_slot = true, synchronous_commit = 'off', binary = false, streaming = 'False', two_phase = false, disable_on_error = false, run_as_owner = false, password_required = true, origin = 'any');
```    

**Добавляем данные в таблицу 1 на первой ВМ**

```SQL
    --pg-01
    insert into replication.test (id) values (1), (2), (3);
    select * from replication.test1;
```
    id
    ----
    1
    2
    3
    (3 rows)

**Проверяем остальные**

```SQL
    --pg-01
    select * from replication.test1;
```
    id
    ----
    1
    2
    3
    (3 rows)


```SQL
    --pg-02
    select * from replication.test1;
```
    id
    ----
    1
    2
    3
    (3 rows)

>**Логическая репликация работает**

---

```SQL
--pg-02:
INSERT INTO replication.test2 (str) VALUES ('qqq'), ('www'), ('eee');
select * from replication.test2;
```
                str
    ------------------------------
    qqq
    www
    eee
    (3 rows)

```SQL
--pg-01:
select * from replication.test2;
```
                str
    ------------------------------
    qqq
    www
    eee
    (3 rows)

```SQL
--pg-03:
select * from replication.test2;
```
                str
    ------------------------------
    qqq
    www
    eee
    (3 rows)

**Вроде бы все работает**
