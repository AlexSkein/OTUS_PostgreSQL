# Отчет по домашке №8

1. Настройте сервер так, чтобы в журнал сообщений сбрасывалась информация о блокировках, удерживаемых более 200 миллисекунд. Воспроизведите ситуацию, при которой в журнале появятся такие сообщения.

    ```SQL
    alter system set log_lock_waits=on;
    alter system set deadlock_timeout=200;
    select pg_reload_conf();
    ```

    ![pg](/img/8/1.jpg)
    
    ![pg](/img/8/2.jpg)

2. Смоделируйте ситуацию обновления одной и той же строки тремя командами UPDATE в разных сеансах. Изучите возникшие блокировки в представлении pg_locks и убедитесь, что все они понятны. Пришлите список блокировок и объясните, что значит каждая.
    
**Запустим 3 сессии и начнем в каждой транзакцию, обновляющую одну и ту же**

```SQL
    begin transaction;
    update  persons set second_name = 'Петрова' where id = 4;
```

**Проверим таблицу блокировок**

```SQL
    select * from pg_locks;
```
    
**Получили вот такой вывод**

```SQL
    locktype	database	relation	page	tuple	virtualxid	transactionid	classid	objid	objsubid	pid	mode	granted	fastpath	waitstart
    relation	5	1 259	 	 	 	 	 	 	 	264 002	AccessShareLock	true	true	 
    relation	5	16 395	 	 	 	 	 	 	 	264 002	RowExclusiveLock	true	true	 
    virtualxid	 	 	 	 	3/13	 	 	 	 	264 002	ExclusiveLock	true	true	 
    relation	5	16 395	 	 	 	 	 	 	 	264 226	RowExclusiveLock	true	true	 
    virtualxid	 	 	 	 	4/9	 	 	 	 	264 226	ExclusiveLock	true	true	 
    relation	5	16 395	 	 	 	 	 	 	 	264 289	RowExclusiveLock	true	true	 
    virtualxid	 	 	 	 	5/9	 	 	 	 	264 289	ExclusiveLock	true	true	 
    relation	5	12 073	 	 	 	 	 	 	 	264 354	AccessShareLock	true	true	 
    virtualxid	 	 	 	 	6/12	 	 	 	 	264 354	ExclusiveLock	true	true	 
    transactionid	 	 	 	 	 	8349460	 	 	 	264 002	ExclusiveLock	true	false	 
    transactionid	 	 	 	 	 	8349461	 	 	 	264 226	ExclusiveLock	true	false	 
    tuple	5	16 395	0	4	 	 	 	 	 	264 289	ExclusiveLock	false	false	2025-10-27 10:30:00.916 +0300
    tuple	5	16 395	0	4	 	 	 	 	 	264 226	ExclusiveLock	true	false	 
    transactionid	 	 	 	 	 	8349460	 	 	 	264 226	ShareLock	false	false	2025-10-27 10:29:33.273 +0300
    transactionid	 	 	 	 	 	8349462	 	 	 	264 289	ExclusiveLock	true	false	 
```

    relation — блокировки отношений;
    transactionid и virtualxid — блокировка номера транзакции (настоящего или виртуального);
    tuple — блокировка версии строки;
    extend — используется при добавлении страниц к файлу какого-либо отношения;
    object — блокировка объектов, которые не являются отношениями (баз данных, схем, подписок и т. п.);
    page — блокировка страницы, используется нечасто и только некоторыми типами индексов;
    advisory — рекомендательная блокировка, устанавливается пользователем вручную.

В нашем сллучае, видим блокировки транзакций с id 8349460, 8349461, 8349462. Заблокирована строка в БД 5, отношение 16395, строка 4.
Данные соответствуют нашей таблице persons и строке, которую мы пытаемся изменить.

    mode ExclusiveLock говорит о том, что для данной строки возможно только чтение.


3. Воспроизведите взаимоблокировку трех транзакций. Можно ли разобраться в ситуации постфактум, изучая журнал сообщений?

    2025-10-27 12:21:22.431 GMT [279172] ПРЕДУПРЕЖДЕНИЕ:  транзакция уже выполняется
    2025-10-27 12:21:22.432 GMT [279172] ПРЕДУПРЕЖДЕНИЕ:  транзакция уже выполняется
    2025-10-27 12:21:30.587 GMT [279173] СООБЩЕНИЕ:  процесс 279173 продолжает ожидать в режиме ShareLock блокировку "транзакция 8349480" в течение 200.088 мс
    2025-10-27 12:21:30.587 GMT [279173] ПОДРОБНОСТИ:  Process holding the lock: 279172. Wait queue: 279173.
    2025-10-27 12:21:30.587 GMT [279173] КОНТЕКСТ:  при изменении кортежа (0,1) в отношении "persons"
    2025-10-27 12:21:30.587 GMT [279173] ОПЕРАТОР:      
            update  persons set second_name = 'Петрова'
    2025-10-27 12:22:41.662 GMT [279173] СООБЩЕНИЕ:  процесс 279173 получил в режиме ShareLock блокировку "транзакция 8349480" через 71275.211 мс
    2025-10-27 12:22:41.662 GMT [279173] КОНТЕКСТ:  при изменении кортежа (0,1) в отношении "persons"
    2025-10-27 12:22:41.662 GMT [279173] ОПЕРАТОР:      
            update  persons set second_name = 'Петрова'
    
    В принципе, что делалось понятно. И разобраться можно.


4. Могут ли две транзакции, выполняющие единственную команду UPDATE одной и той же таблицы (без where), заблокировать друг друга?

    Взаимоблокировка 2-х транзакций, выполняющих UPDATE одной и той же таблицы (без where) возможна, если одна команда будет обновлять строки таблицы в прямом порядке, а другая - в обратном. Такое может произойти в реальной жизни (но это маловероятно), если для команд будут построены разные планы выполнения, например, одна будет читать таблицу последовательно, а другая - по индексу