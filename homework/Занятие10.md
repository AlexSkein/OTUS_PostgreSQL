# Отчет по домашке №10
**Создаем таблицу**

```SQL
CREATE TABLE IF NOT EXISTS users (
    id 			serial UNIQUE PRIMARY KEY,
    username    varchar(50) UNIQUE,
    email       varchar(100),
    age         int    
);

INSERT INTO users (username, email, age)
SELECT 
    'user_' || s,
    'user_' || s || '@mail.ru',
	-- age: случайное число от 18 до 70
    18 + (random() * 52)::int	
FROM generate_series(1, 1000000) s;

--При создании автоматически создался индекс 
--CREATE UNIQUE INDEX users_username_key ON public.users USING btree (username);
```
Создать индекс к какой-либо из таблиц вашей БД
**Выполним запрос на выборку пользователей по возрасту от 40 до 50**

```SQL
explain analyze
select * from users u where age > 40 and age < 50
```
    QUERY PLAN                                                                                                     |
    ---------------------------------------------------------------------------------------------------------------+
    Seq Scan on users u  (cost=0.00..23334.00 rows=173420 width=38) (actual time=0.009..74.175 rows=173473 loops=1)|
    Filter: ((age > 40) AND (age < 50))                                                                          |
    Rows Removed by Filter: 826527                                                                               |
    Planning Time: 0.091 ms                                                                                        |
    Execution Time: 79.164 ms                                                                                      |

Добавим индекс на столбец age
```SQL
CREATE INDEX users_age_idx ON public.users (age);
analyze;
```
**Снова выполним запрос**
```SQL
explain analyze
select * from users u where age > 40 and age < 50
```
Прислать текстом результат команды explain, в которой используется данный индекс
QUERY PLAN                                                                                                                       |
    ---------------------------------------------------------------------------------------------------------------------------------+
    Bitmap Heap Scan on users u  (cost=2369.98..13305.28 rows=173420 width=38) (actual time=5.809..35.436 rows=173473 loops=1)       |
    Recheck Cond: ((age > 40) AND (age < 50))                                                                                      |
    Heap Blocks: exact=8334                                                                                                        |
    ->  Bitmap Index Scan on users_age_idx  (cost=0.00..2326.62 rows=173420 width=0) (actual time=4.623..4.623 rows=173473 loops=1)|
            Index Cond: ((age > 40) AND (age < 50))                                                                                  |
    Planning Time: 0.127 ms                                                                                                          |
    Execution Time: 40.273 ms

**Видим использование индекса и сокращение времени на выполнение запроса**
    
Реализовать индекс для полнотекстового поиска
**Для полнотекстового поиска нужен текст**

В сети нашел функцию:
```SQL
CREATE OR REPLACE FUNCTION lorem_ipsum(length bigint) RETURNS text AS $$
DECLARE
    result text;
BEGIN
    SELECT string_agg(word, ' ' ORDER BY gen_random_uuid()) INTO result
    FROM (
        SELECT UNNEST(ARRAY[
            'lorem', 'ipsum', 'dolor', 'sit', 'amet,', 'consectetur', 'adipiscing', 'elit,',
            'sed', 'do', 'eiusmod', 'tempor', 'incididunt', 'ut', 'labore', 'et', 'dolore',
            'magna', 'aliqua.', 'ut', 'enim', 'ad', 'minim', 'veniam,', 'quis', 'nostrud',
            'exercitation', 'ullamco', 'laboris', 'nisi', 'aliquip', 'ex', 'ea', 'commodo',
            'consequat.', 'duis', 'aute', 'irure', 'in', 'reprehenderit', 'voluptate', 'velit',
            'esse', 'cillum', 'eu', 'fugiat', 'nulla', 'pariatur.', 'excepteur', 'sint',
            'occaecat', 'cupidatat', 'non', 'proident,', 'sunt', 'culpa', 'qui', 'officia',
            'deserunt', 'mollit', 'anim', 'id', 'est', 'laborum'
        ]) AS word
    ) words;

    RETURN initcap(substring(result FROM 1 FOR length::int));
END;
$$ LANGUAGE plpgsql;

ALTER TABLE public.users ADD lorem text NULL;

-- Заполним столбец текстом
update users set lorem = lorem_ipsum(255);
-- Построим план запроса
explain analyze
select * from users where lorem like '%Quis Est Enim%'
```
QUERY PLAN                                                                                                             |
-----------------------------------------------------------------------------------------------------------------------+
Gather  (cost=1000.00..214543.88 rows=100 width=297) (actual time=2.938..392.672 rows=141 loops=1)                     |
  Workers Planned: 2                                                                                                   |
  Workers Launched: 2                                                                                                  |
  ->  Parallel Seq Scan on users  (cost=0.00..213533.88 rows=42 width=297) (actual time=2.505..365.416 rows=47 loops=3)|
        Filter: (lorem ~~ '%Quis Est Enim%'::text)                                                                     |
        Rows Removed by Filter: 333286                                                                                 |
Planning Time: 0.402 ms                                                                                                |
Execution Time: 392.706 ms                                                                                             |

```SQL
--  Добавим расширение для GIN индекса
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- Создадим индекс

CREATE INDEX idx_users_lorem ON public.users USING gin	(lorem gin_trgm_ops);

ANALYZE users;

--Снова построим план

explain analyze
select * from users where lorem like '%Quis Est Enim%'
```
QUERY PLAN                                                                                                                          |
------------------------------------------------------------------------------------------------------------------------------------+
Bitmap Heap Scan on users  (cost=3350.12..3744.80 rows=100 width=297) (actual time=233.780..442.425 rows=141 loops=1)               |
  Recheck Cond: (lorem ~~ '%Quis Est Enim%'::text)                                                                                  |
  Rows Removed by Index Recheck: 289368                                                                                             |
  Heap Blocks: exact=82736                                                                                                          |
  ->  Bitmap Index Scan on idx_users_lorem  (cost=0.00..3350.10 rows=100 width=0) (actual time=218.809..218.810 rows=289509 loops=1)|
        Index Cond: (lorem ~~ '%Quis Est Enim%'::text)                                                                              |
Planning Time: 0.568 ms                                                                                                             |
Execution Time: 442.476 ms                                                                                                          |

Реализовать индекс на часть таблицы или индекс на поле с функцией




Создать индекс на несколько полей
Написать комментарии к каждому из индексов
Описать что и как делали и с какими проблемами
столкнулись