# Отчет по домашке №10
**Создаем таблицу**

```SQL
CREATE TABLE IF NOT EXISTS users (
    id 			serial UNIQUE PRIMARY KEY,
    username    varchar(50) UNIQUE,
    email       varchar(100),
    age         int    
);

INSERT INTO users (username, email, age)
SELECT 
    'user_' || s,
    'user_' || s || '@mail.ru',
	-- age: случайное число от 18 до 70
    18 + (random() * 52)::int	
FROM generate_series(1, 1000000) s;

--При создании автоматически создался индекс 
--CREATE UNIQUE INDEX users_username_key ON public.users USING btree (username);
```
Создать индекс к какой-либо из таблиц вашей БД

**Выполним запрос на выборку пользователей по возрасту от 40 до 50**

```SQL
explain analyze
select * from users u where age > 40 and age < 50
```
   QUERY PLAN                                                                                                     \
   ---------------------------------------------------------------------------------------------------------------+\
   Seq Scan on users u  (cost=0.00..23334.00 rows=173420 width=38) (actual time=0.009..74.175 rows=173473 loops=1)\
     Filter: ((age > 40) AND (age < 50))                                                                          \
     Rows Removed by Filter: 826527                                                                               \
   Planning Time: 0.091 ms                                                                                        \
   Execution Time: 79.164 ms                                                                                      

Добавим индекс на столбец age
```SQL
CREATE INDEX users_age_idx ON public.users (age);
analyze;
```
**Снова выполним запрос**
```SQL
explain analyze
select * from users u where age > 40 and age < 50
```
Прислать текстом результат команды explain, в которой используется данный индекс
>   QUERY PLAN                                                                                                                      \
    ---------------------------------------------------------------------------------------------------------------------------------+\
    Bitmap Heap Scan on users u  (cost=2369.98..13305.28 rows=173420 width=38) (actual time=5.809..35.436 rows=173473 loops=1)      \
    Recheck Cond: ((age > 40) AND (age < 50))                                                                                      \
    Heap Blocks: exact=8334                                                                                                        \
    ->  Bitmap Index Scan on users_age_idx  (cost=0.00..2326.62 rows=173420 width=0) (actual time=4.623..4.623 rows=173473 loops=1)|
            Index Cond: ((age > 40) AND (age < 50))                                                                                 \
    Planning Time: 0.127 ms                                                                                                         \
    Execution Time: 40.273 ms

**Видим использование индекса и сокращение времени на выполнение запроса**
    
Реализовать индекс для полнотекстового поиска
**Для полнотекстового поиска нужен текст**

**Создаем таблицу**

```SQL
CREATE TABLE documents (
    id SERIAL PRIMARY KEY,
    title TEXT,
    body TEXT,
    tsvector_col TSVECTOR
)

--Вместо того, чтобы создавать индекс просто сохраним его в отдельный столбец tsvector_col**

INSERT INTO documents (title, body, tsvector_col) VALUES 
('Artificial Intelligence', 'Artificial intelligence (AI) is a field of computer science that aims to create intelligent machines.', to_tsvector('english', 'Artificial intelligence (AI) is a field of computer science that aims to create intelligent machines.')),
('Machine Learning', 'Machine learning is a subset of AI that allows systems to learn from data.', to_tsvector('english', 'Machine learning is a subset of AI that allows systems to learn from data.')),
('Deep Learning', 'Deep learning is a subset of machine learning that uses neural networks to model complex patterns.', to_tsvector('english', 'Deep learning is a subset of machine learning that uses neural networks to model complex patterns.')),
('Data Science', 'Data science involves the use of statistical methods to extract insights from data.', to_tsvector('english', 'Data science involves the use of statistical ethods to extract insights from data.'));
```

![pg](/img/9/1.jpg)

Запрос с использованием tsquery

```SQL
SELECT * FROM documents WHERE tsvector_col @@ to_tsquery('english', 'machine & learning');
```

![pg](/img/9/2.jpg)


Реализовать индекс на часть таблицы или индекс на поле с функцией
**Добавим в таблицу users столбец active**

```SQL
ALTER TABLE public.users ADD active bool NOT NULL DEFAULT true;
-- Деактивируем пользователей от 40 до 50 лет
update users set active = false where age > 40 and age < 50
-- Cоздадим индекс для активных пользователей
CREATE INDEX idx_active_users ON users (id) WHERE active = true
```

Создать индекс на несколько полей
```SQL
CREATE INDEX idx_users_username_age ON users(username, age);
```

Написать комментарии к каждому из индексов
> users_age_idx - простой индекс btree по полю age
> tsvector_col - храним в виде столбца в таблице

Описать что и как делали и с какими проблемами столкнулись
> Во время экспериментов была проблема с расширением anon в alt-linux. Разработчики, похоже, не очень любят PostgreSQL
> Решилась добавлением симлинков.


